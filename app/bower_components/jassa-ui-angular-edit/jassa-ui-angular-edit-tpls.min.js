/*
 * jassa-ui-angular-edit
 * https://github.com/GeoKnow/Jassa-UI-Angular

 * Version: 0.9.0-SNAPSHOT - 2015-03-25
 * License: BSD
 */
function capitalize(a){return a&&a[0].toUpperCase()+a.slice(1)}angular.module("ui.jassa.edit",["ui.jassa.edit.tpls","ui.jassa.geometry-input","ui.jassa.rdf-term-input","ui.jassa.rex","ui.jassa.sync"]),angular.module("ui.jassa.edit.tpls",["template/geometry-input/geometry-input-typeahead.html","template/geometry-input/geometry-input.html","template/rdf-term-input/rdf-term-input.html"]),angular.module("ui.jassa.geometry-input",[]).provider("GeocodingLookup",function(){this.config={service:["Nominatim","LinkedGeoData"],defaultService:!1},this.defaultServices={Nominatim:{label:"Nominatim",serviceType:"rest",url:"http://nominatim.openstreetmap.org/search/?format=json&polygon_text=1&q=",data:{format:"json",polygon_text:"1",q:"%KEYWORD%"},fnSuccess:function(a){var b=a.data,c=[];for(var d in b)b[d].hasOwnProperty("geotext")&&c.push({firstInGroup:!1,wkt:b[d].geotext,label:b[d].display_name,group:"Nominatim"});return c}},LinkedGeoData:{label:"LinkedGeoData",serviceType:"sparql",endpoint:"http://linkedgeodata.org/vsparql",graph:"http://linkedgeodata.org/ne/",prefix:{ogc:"http://www.opengis.net/ont/geosparql#",geom:"http://geovocab.org/geometry#"},query:'{ Graph <http://linkedgeodata.org/ne/> { ?s a <http://linkedgeodata.org/ne/ontology/Country> ; rdfs:label ?l ; geom:geometry [  ogc:asWKT ?g ]  FILTER regex(?l, "%KEYWORD%", "i")  } }',sponateTemplate:[{id:"?s",label:"?l",wkt:"?g"}],limit:5,fnSuccess:function(a){var b=a,c=[];if(b.length>0)for(var d in b)c.push({firstInGroup:!1,wkt:b[d].val.wkt,label:b[d].val.label,group:"LinkedGeoData"});return c}}},this.userServices={},this.$get=function(){var a=angular.injector(["ng"]),b=a.get("$http"),c=a.get("$q"),d={promisesMetaInformation:[],promises:[]},e={};for(var f in this.config.service){var g=this.config.service[f];e[g]=this.defaultServices[g]}_(this.userServices).isEmpty()||(this.config.defaultService?_(e).extend(this.userServices):e=this.userServices);var h=function(a,b){var c=d.promises.length;d.promisesMetaInformation.push({label:a,promiseID:c}),d.promises.push(b)},i=function(){return d},j=function(){d.promises=[],d.promisesMetaInformation=[]},k=function(a,b){var c=jassa.service.SparqlServiceBuilder.http(a,b,{type:"POST"}).cache().virtFix().paginate(1e3).pageExpand(100).create();return c},l=function(a,b){return"rest"===a.serviceType?m(a,b):"sparql"===a.serviceType?n(a,b):void 0},m=function(a,c){var d=o(a.data).replace(/%KEYWORD%/gi,c);return b({method:"GET",url:a.url+"?"+d,cache:!0,headers:{Accept:"application/json","Content-Type":"application/json"}})},n=function(a,b){var c=k(a.endpoint,a.graph),d=new jassa.sponate.StoreFacade(c,_(a.prefix).defaults(jassa.vocab.InitialContext)),e=a.query.replace(/%KEYWORD%/gi,b),f=a.limit||10;return d.addMap({name:"sparqlService",template:a.sponateTemplate,from:e}),d.sparqlService.getListService().fetchItems(null,f)},o=function(a){var b=[];for(var c in a)b.push(c+"="+a[c]);return b.join("&")},p=function(a){return a=_(a).flatten(),a=_(a).groupBy("group"),a=_(a).map(function(a){return a[0].firstInGroup=!0,a}),a=_(a).flatten(),a=_(a).value()};return{findByKeyword:function(a){j();for(var b in e){var d=e[b],f=l(d,a);h(b,f)}var g=i(),k=c.all(g.promises).then(function(a){var b=[];for(var c in a){var d=a[c],f=g.promisesMetaInformation[c].label,h=e[f].fnSuccess(d);b.push(h)}return p(b)});return k}}},this.setService=function(a){this.userServices[a.label]=a},this.setConfiguration=function(a){_(this.config).extend(a)}}).directive("geometryInput",["$http","$q","GeocodingLookup",function(a,b,c){var d=1;return{restrict:"EA",priority:4,require:"?ngModel",templateUrl:"template/geometry-input/geometry-input.html",replace:!0,scope:{bindModel:"=ngModel",ngModelOptions:"=?",geocodingServices:"=geocodingServices"},controller:["$scope",function(a){a.ngModelOptions=a.ngModelOptions||{},a.geometry="point",a.isLoading=!1,a.fetchResults=function(a){return c.findByKeyword(a)},a.onSelectGeocode=function(b){console.log("onselect",b),a.bindModel=b.wkt}}],compile:function(){return{pre:function(a,b,c,e){function f(){var a="openlayers-map-"+d++;b.find(".map").attr("id",a),n=new OpenLayers.Map(a);var c=new OpenLayers.Layer.WMS("OpenLayers WMS","http://vmap0.tiles.osgeo.org/wms/vmap0?",{layers:"basic"});p=new OpenLayers.Control.Panel({displayClass:"olControlEditingToolbar"});var e={methods:["vertex","edge"],layers:[r]},f=OpenLayers.Util.getParameters(window.location.href).renderer;f=f?[f]:OpenLayers.Layer.Vector.prototype.renderers,r=new OpenLayers.Layer.Vector("Vector Layer",{renderers:f}),n.addLayers([c,r]),n.addControl(new OpenLayers.Control.LayerSwitcher),n.addControl(new OpenLayers.Control.MousePosition),r.events.on({sketchcomplete:g}),q=new OpenLayers.Format.WKT,o={point:new OpenLayers.Control.DrawFeature(r,OpenLayers.Handler.Point,{displayClass:"olControlDrawFeaturePoint",handlerOptions:e}),line:new OpenLayers.Control.DrawFeature(r,OpenLayers.Handler.Path,{displayClass:"olControlDrawFeaturePath",handlerOptions:e}),polygon:new OpenLayers.Control.DrawFeature(r,OpenLayers.Handler.Polygon,{displayClass:"olControlDrawFeaturePolygon",handlerOptions:e}),box:new OpenLayers.Control.DrawFeature(r,OpenLayers.Handler.RegularPolygon,{displayClass:"olControlDrawFeatureBox",handlerOptions:_.extend({sides:4,irregular:!0},e)}),modify:new OpenLayers.Control.ModifyFeature(r,{snappingOptions:e,onModificationStart:k,onModification:l,onModificationEnd:m})},p.addControls(o.modify),n.addControl(p),p.activateControl(o.modify);for(var h in o)n.addControl(o[h]);n.setCenter(new OpenLayers.LonLat(0,0),4)}function g(b){var c=h(b.feature);a.bindModel=c,a.$apply()}function h(a){var b=q.write(a);return b=b.replace(/,/g,", ")}function i(b){var c,d=b||a.bindModel,e=q.read(d);if(e){e.constructor!=Array&&(e=[e]);for(var f=0;f<e.length;++f)c?c.extend(e[f].geometry.getBounds()):c=e[f].geometry.getBounds();r.addFeatures(e),n.zoomToExtent(c);{e.length>1?"s":""}}else console.log("Bad WKT")}function j(){var b=o[a.geometry];for(var c in o)b=o[c],a.geometry==c?b.activate():b.deactivate()}function k(){o[a.geometry].deactivate()}function l(b){var c=h(b);a.bindModel=c,e.$setDirty(),a.$$phase&&a.$apply()}function m(){o[a.geometry].activate()}e.$name=a.$eval(c.name),a.searchString="";var n,o,p,q,r;a.$watch(function(){return a.bindModel},function(b){r.destroyFeatures(),a.bindModel=b,null!=a.bindModel&&i()}),a.$watch(function(){return a.geometry},function(){j()}),f();var s=o[a.geometry];s.activate()}}}}}]);var rdfTermInputCounter=0;angular.module("ui.jassa.rdf-term-input",[]).directive("rdfTermInput",["$parse",function(){var a={iri:"http://iri",plainLiteral:"http://plainLiteral",typedLiteral:"http://typedLiteral"};return{restrict:"EA",priority:0,require:"ngModel",templateUrl:"template/rdf-term-input/rdf-term-input.html",replace:!0,scope:{bindModel:"=ngModel",ngModelOptions:"=?",logo:"@?",langs:"=?",datatypes:"=?",rightButton:"=?"},controller:["$scope",function(b){b.forms={},b.state=b.$state||{},b.ngModelOptions=b.ngModelOptions||{},this.setRightButton=function(){b.rightButton=!0},b.vocab=a,b.termTypes=[{id:a.iri,displayLabel:"IRI"},{id:a.plainLiteral,displayLabel:"plain"},{id:a.typedLiteral,displayLabel:"typed"}];var c=[{id:"",displayLabel:"(none)"},{id:"en",displayLabel:"en"},{id:"de",displayLabel:"de"},{id:"fr",displayLabel:"fr"},{id:"zh",displayLabel:"zh"},{id:"ja",displayLabel:"ja"}];b.langs=b.langs||c;var d=Object.keys(jassa.vocab.xsd);b.datatypes=d.map(function(a){var b=jassa.vocab.xsd[a].getUri();return{id:b,displayLabel:jassa.util.UriUtils.extractLabel(b)}}),b.addLanguage=function(a){return{id:a,displayLabel:a}},b.addDatatype=function(a){return{id:a,displayLabel:a}}}],compile:function(){return{pre:function(b,c,d,e){e.$name=b.$eval(d.name);var f=function(){var a=[b.forms.type.value,b.forms.datatype.value,b.forms.lang.value,b.forms.value.value];return a},g=function(){var a=f(),b=!a.some(function(a){return!a.$pristine});return b};b.$watch(function(){return e.$pristine},function(a){if(a){var b=f();b.forEach(function(a){a.$setPristine()})}}),b.$watch(g,function(a){a?e.$setPristine():e.$setDirty()}),b.rightButton=!1,b.setRightButton=function(){b.rightButton=!0};var h=function(){var c,d=b.state,e=d.type;switch(e){case a.iri:c={type:"uri",value:d.value};break;case a.plainLiteral:c={type:"literal",value:d.value,lang:d.lang,datatype:""};break;case a.typedLiteral:c={type:"literal",value:d.value,datatype:d.datatype||jassa.vocab.xsd.xstring.getUri()};break;default:c={type:"uri",value:d.value}}return c},i=function(b){var c=b;null!=c.type&&null==c.value&&(c.value="");var d;try{d=jassa.rdf.NodeFactory.createFromTalisRdfJson(c)}catch(e){}var f;if(d){if(d.isUri())f={type:a.iri,value:d.getUri()};else if(d.isLiteral()){var g=d.getLiteralDatatypeUri(),h=!jassa.util.ObjectUtils.isEmptyString(g);f=h?{type:a.typedLiteral,value:d.getLiteralLexicalForm(),datatype:g}:{type:a.plainLiteral,value:d.getLiteralLexicalForm(),lang:d.getLiteralLanguage()}}}else f={};return f};b.$watch(function(){var a=b.bindModel;return a},function(a){if(a){var c=i(a);b.state=c;for(var d in b.termTypes)if(b.termTypes[d].id===b.state.type){b.termTypes.selected=b.termTypes[d];break}var e=!1;for(var f in b.datatypes)if(b.datatypes[f].id===b.state.datatype){b.datatypes.selected=b.datatypes[f],e=!0;break}if(!e){var g=new jassa.rdf.PrefixMappingImpl,h={id:b.state.datatype,displayLabel:g.shortForm(b.state.datatype)};b.datatypes.push(h),b.datatypes.selected=h}var j=!1;for(var k in b.langs)if(b.langs[k].id===b.state.lang){b.langs.selected=b.langs[k],j=!0;break}if(!j){var l={id:b.state.lang,displayLabel:b.state.lang};b.langs.push(l),b.langs.selected=l}}else;},!0),b.$watch(function(){var a=h();return a},function(a){a&&angular.copy(a,b.bindModel)},!0)}}}}}]);var Coordinate=Jassa.ext.Class.create({initialize:function(a,b,c,d){this.s=a||"",this.p=b||"",this.i=c||0,this.c=d||""},equals:function(a){var b=this.s===a.s&&this.p===a.p&&this.i===a.i&&this.c===a.c;return b},hashCode:function(){return null==this.hash&&(this.hash=jassa.util.ObjectUtils.hashCodeStr(this.s)+3*jassa.util.ObjectUtils.hashCodeStr(this.p)+7*this.i+11*jassa.util.ObjectUtils.hashCodeStr(this.c)),this.hash},toString:function(){var a=this.s+" "+this.p+" "+this.i+" "+this.c;return a}}),parsePrefixStr=function(){regex=/\s*([^:]+)\s*:\s*([^\s]+)\s*/g},parsePrefixes=function(a){var b=a?a instanceof PrefixMappingImpl?a:new PrefixMappingImpl(a):new PrefixMappingImpl;return b},getModelAttribute=function(a){var b=["ngModel","model"],c=Object.keys(a),d=null;return b.some(function(a){var b=c.indexOf(a)>=0;return b&&(d=a),b}),d},createCompileComponent=function(a,b,c,d){return{pre:function(e,f,g,h){var i=g[a],j=c(i),k=j.assign;d||syncAttr(c,e,g,a);var l=h[0],m=h[2],n=l.allocSlot();n.entry={},e.$on("$destroy",function(){n.release(),q()}),n.entry.key=createCoordinate(e,b);var o=j(e);o&&setValueAt(l.getOverride(),n.entry.key,o);var p=function(){var a=n.entry.key,b=e.rexContext.dirty,c=b[a]=b[a]||{};c[n.id]=!0},q=function(a){a=a||n.entry.key;var b=e.rexContext.dirty,c=b[a];c&&(delete c[n.id],0===Object.keys(c).length&&delete b[a])},r=function(a){var c;if("deleted"===b)c=!0;else{a=a||n.entry.key;var d=e.rexContext.dirty,f=d[a];c=!!f}return c};if(m){var s=function(){m.$pristine?q():p()};e.$watch(s)}e.$watch(function(){var a=createCoordinate(e,b);return a},function(a,b){if(a&&!a.equals(b)){var c=r(b);n.entry.key=a;var d=c?getEffectiveValue(e.rexContext,b):getEffectiveValue(e.rexContext,a);setValueAt(l.getOverride(),a,d),q(b)}},!0),d||e.$watch(function(){var a=n.entry.key,b=getEffectiveValue(e.rexContext,a);return b},function(a){n.entry.key;k&&k(e,a)},!0),e.$watch(function(){var a=j(e);return a},function(a){var b=n.entry.key;setValueAt(l.getOverride(),b,a)},!0)}}},assembleTalisRdfJson=function(a){var b={},c=a.entries();return c.forEach(function(c){var d=c.key,e=new Coordinate(d.s,d.p,d.i,"deleted"),f=a.get(e);if(!f){var g=c.val,h=b,i=h[d.s]=h[d.s]||{},j=i[d.p]=i[d.p]||[],k=j[d.i]=j[d.i]||{};k[d.c]=g}}),b},processPrefixes=function(a,b){var c={},d=a,e=Object.keys(d);return e.forEach(function(a){var c=d[a],e=Object.keys(c);e.forEach(function(a){var d=c[a];d.forEach(function(a){var c=b;if(c)if("uri"===a.type){var d=a.value;a.value=c.expandPrefix(d)}else if("literal"===a.type&&null!=a.datatype){var e=a.datatype;a.datatype=c.expandPrefix(e)}})})}),c},createCoordinate=function(a,b){return new Coordinate(a.rexSubject,a.rexPredicate,a.rexObject,b)},talisRdfJsonToEntries=function(a){var b=[],c=a,d=Object.keys(c);return d.forEach(function(a){var d=c[a],e=Object.keys(d);e.forEach(function(c){var e=d[c],f=0;e.forEach(function(d){var e=Object.keys(d);e.forEach(function(e){var g=d[e],h=new Coordinate(a,c,f,e);b.push({key:h,val:g})}),++f})})}),b},getObjectsAt=function(a,b){var c=b?a[b.s]:null,d=c?c[b.p]:null;return d},getObjectAt=function(a,b){var c=getObjectsAt(a,b),d=c?c[b.i]:null;return d},getOrCreateObjectAt=function(a,b,c){var d=a[b.s]=a[b.s]||{},e=d[b.p]=d[b.p]||[],f=e[b.i]=e[b.i]||c||{};return f},compactTrailingNulls=function(a){for(;a.length&&null==a[a.length-1];)a.pop()},removeValueAt=function(a,b){var c=a[b.s],d=c?c[b.p]:null,e=d?d[b.i]:null;e&&(delete e[b.c],0===Object.keys(e).length&&(delete d[b.i],compactTrailingNulls(d),0===d.length&&(delete c[b.p],0===Object.keys(c).length&&delete a[b.s])))},setValueAt=function(a,b,c){if(null!=b){var d=getOrCreateObjectAt(a,b);d[b.c]=c}},getValueAt=function(a,b){var c=getObjectAt(a,b),d=c?c[b.c]:null;return d},diff=function(a,b){var c=new jassa.util.HashSet;return b.forEach(function(b){var d=a.contains(b);d||c.add(b)}),c},setDiff=function(a,b){var c={added:diff(a,b),removed:diff(b,a)};return c},getEffectiveValue=function(a,b){var c=a.override?getValueAt(a.override,b):null;return null==c&&(c=a.json?getValueAt(a.json,b):null),c},syncAttr=function(a,b,c,d,e,f){var g=c[d],h=a(g),i=function(){var a=h(b),c=f?f(a):a;return c};b.$watch(i,function(a){b[d]=a},e);var j=i();return b[d]=j,j},setEleAttrDefaultValue=function(a,b,c,d){var e=a.attr(c);if(!e){e=d,a.attr(c,e);var f=b.$normalize(c);b[f]=e}return e};angular.module("ui.jassa.rex",["dddi","ui.select"]),angular.module("ui.jassa.rex").directive("rexContext",["$parse","$q","$dddi",function(a,b,c){return{priority:30,restrict:"A",scope:!0,require:"rexContext",controller:["$scope",function(a){a.rexContext=a.rexContext||{},this.$scope=a,this.getOverride=function(){var b=a.rexContext,c=b?b.override:null;return c},this.nextSlot=0,a.rexChangeSlots={},this.allocSlot=function(){var b=this.nextSlot++,c="slot_"+b,d=a.rexChangeSlots[c]={id:c,release:function(){delete a.rexChangeSlots[c]}};return d},this.getSlots=function(){var b=a.rexChangeSlots,c=Object.keys(b),d=c.map(function(a){var c=b[a];return c});return d},this.getEnforcedGraph=function(){var a=new jassa.rdf.GraphImpl,b=this.getSlots();return b.forEach(function(b){var c=b.triples;c&&a.addAll(c)}),a},this.getReferencedCoordinates=function(){var a=new jassa.util.HashSet,b=this.getSlots();return b.forEach(function(b){var c=b.entry,d=c?c.key:null;null!=d&&a.add(d)}),a}}],compile:function(d,e){return setEleAttrDefaultValue(d,e,"rex-context","rexContext"),{pre:function(d,e,f,g){syncAttr(a,d,f,"rexContext");var h=function(a){a.override=a.override||{},a.dirty=a.dirty||{},a.refSubjects=a.refSubjects||{},a.srcGraph=a.srcGraph||new jassa.rdf.GraphImpl,a.reset=function(){var c=k().then(function(){var b=g.getReferencedCoordinates();return b.forEach(function(b){var c=(getEffectiveValue(a,b),getValueAt(a.json,b));setValueAt(a.override,b,c)}),!0});return c=b.when(c)}},i=function(a){var b=[];return function(){for(var c=a();b.length;)b.pop();return b.push.apply(b,c),b}},j=i(function(){var a=Object.keys(d.rexContext.refSubjects);return a}),k=function(){var a,b=d.rexLookup,c=d.rexSparqlService,e=d.rexContext.subjects;if(b&&c&&e){var f=e.map(function(a){return jassa.rdf.NodeFactory.createUri(a)}),g=new jassa.service.LookupServiceGraphSparql(c),h=g.lookup(f);a=h.then(function(a){var b=d.rexContext,c=b.baseGraph=b.baseGraph||new jassa.rdf.GraphImpl;a.forEach(function(a,b){var d=new jassa.rdf.Triple(b,null,null);c.removeMatch(d),c.addAll(a)})})}else a=Promise.resolve();return a=a.then(function(){var a=d.rexContext;a.json=a.baseGraph?jassa.io.TalisRdfJsonUtils.triplesToTalisRdfJson(a.baseGraph):{}})};d.$watchCollection("[rexSparqlService, rexLookup, rexPrefixMapping]",function(){b.when(k())}),d.$watchCollection(j,function(a){d.rexContext.subjects=a,console.log("Subjects: "+JSON.stringify(a)),b.when(k())}),d.$watch(function(){return d.rexContext},function(a){h(a)}),h(d.rexContext);var l=function(){var a=d.rexContext,b=a?a.baseGraph:null;return b};d.$watch(function(){var a=l(),b=a?a.hashCode():null;return b},function(){var a=l();d.rexContext.json=a?jassa.io.TalisRdfJsonUtils.triplesToTalisRdfJson(a):{}});var m=function(a){var b=(g.getOverride(),new jassa.util.HashMap);return a.forEach(function(a){var c=getEffectiveValue(d.rexContext,a);b.put(a,c)}),b},n=function(a,b){var c=assembleTalisRdfJson(a);processPrefixes(c,b);var d=jassa.io.TalisRdfJsonUtils.talisRdfJsonToGraph(c);return d},o=function(){var a=new jassa.rdf.GraphImpl,b=g.getReferencedCoordinates(),c=d.rexContext.json;return b.forEach(function(b){var d=getObjectAt(c,b);if(null!=d){var e=jassa.rdf.NodeFactory.createFromTalisRdfJson(d),f=jassa.rdf.NodeFactory.createUri(b.s),g=jassa.rdf.NodeFactory.createUri(b.p),h=new jassa.rdf.Triple(f,g,e);a.add(h)}}),a},p=function(a){var b=g.getOverride(),c=talisRdfJsonToEntries(b);c.forEach(function(c){var d=c.key,e=a.contains(d);e||removeValueAt(b,d)})},q=new jassa.util.HashSet;d.$watch(function(){q=g.getReferencedCoordinates();var a=q.hashCode();return a},function(){p(q)},!0);var r=c(d);d.currentDataMap=new jassa.util.HashMap,r.register("currentDataMap",function(){var a=m(q);return a=a.hashCode()===d.currentDataMap.hashCode()?d.currentDataMap:a}),r.register("rexContext.graph",["currentDataMap.hashCode()",function(){var a=n(d.currentDataMap,d.rexContext.prefixMapping),b=g.getEnforcedGraph();return a.addAll(b),a}]),r.register("rexContext.targetJson",["rexContext.graph.hashCode()",function(){var a=jassa.io.TalisRdfJsonUtils.triplesToTalisRdfJson(d.rexContext.graph);return a}]),r.register("rexContext.srcGraph",function(){var a=o();return a=a.hashCode()===d.rexContext.srcGraph.hashCode()?d.rexContext.srcGraph:a}),r.register("rexContext.diff",["rexContext.srcGraph.hashCode()","rexContext.graph.hashCode()",function(){var a=setDiff(d.rexContext.srcGraph,d.rexContext.graph);return a}])}}}}}]),angular.module("ui.jassa.rex").directive("rexDatatype",["$parse",function(a){return{priority:7,restrict:"A",scope:!0,require:["^rexContext","^rexObject","?ngModel"],controller:angular.noop,compile:function(){return createCompileComponent("rexDatatype","datatype",a)}}}]),angular.module("ui.jassa.rex").directive("rexDeleted",["$parse",function(a){return{priority:7,restrict:"A",scope:!0,require:["^rexContext","^rexObject","?ngModel"],controller:angular.noop,compile:function(){return createCompileComponent("rexDeleted","deleted",a)}}}]),angular.module("ui.jassa.rex").directive("rexIri",["$parse","$compile",function(a,b){return{priority:900,restrict:"A",scope:!0,terminal:!0,controller:angular.noop,compile:function(){return{pre:function(a,c,d){var e=c.attr("rex-iri");if(jassa.util.ObjectUtils.isEmptyString(e)){var f=getModelAttribute(d);e=d[f]}if(!e)throw new Error("No model provided and found");c.removeAttr("rex-iri"),c.attr("rex-object",""),c.attr("rex-termtype",'"uri"'),c.attr("rex-value",e),b(c)(a)}}}}}]),angular.module("ui.jassa.rex").directive("rexLang",["$parse",function(a){return{priority:7,restrict:"A",scope:!0,require:["^rexContext","^rexObject","?ngModel"],controller:angular.noop,compile:function(){return createCompileComponent("rexLang","lang",a)}}}]),angular.module("ui.jassa.rex").directive("rexLiteral",["$parse","$compile",function(a,b){return{priority:900,restrict:"A",scope:!0,terminal:!0,controller:angular.noop,compile:function(){return{pre:function(a,c,d){var e=c.attr("rex-literal");if(jassa.util.ObjectUtils.isEmptyString(e)){var f=getModelAttribute(d);e=d[f]}if(!e)throw new Error("No model provided and found");c.removeAttr("rex-literal"),c.attr("rex-object",""),c.attr("rex-termtype",'"literal"'),c.attr("rex-value",e),b(c)(a)}}}}}]),angular.module("ui.jassa.rex").directive("rexLookup",["$parse",function(a){return{priority:26,restrict:"A",scope:!0,require:"^rexContext",controller:angular.noop,compile:function(){return{pre:function(b,c,d){syncAttr(a,b,d,"rexLookup")}}}}}]),angular.module("ui.jassa.rex").directive("rexNavTargets",["$parse","$q","$dddi",function(a,b,c){return{priority:10,restrict:"A",scope:!0,require:["^rexContext","^rexSubject"],controller:angular.noop,compile:function(){return{pre:function(b,d,e,f){var g=f[0],h=g.allocSlot();h.triples=[],b.$on("$destroy",function(){h.release()}),syncAttr(a,b,e,"rexNavPredicate"),syncAttr(a,b,e,"rexNavInverse");var i=d.attr("rex-nav-targets"),j=c(b);j.register(i,["rexSparqlService","rexSubject","rexNavPredicate","?rexNavInverse",function(a,c,d,e){var f=b.rexPrefixMapping||new jassa.rdf.PrefixMappingImpl(jassa.vocab.InitialContext);c=f.expandPrefix(c),d=f.expandPrefix(d);var g=jassa.sparql.VarUtils.s,h=jassa.rdf.NodeFactory.createUri(d),i=jassa.rdf.NodeFactory.createUri(c),j=e?new jassa.rdf.Triple(g,h,i):new jassa.rdf.Triple(i,h,g),k=new jassa.sparql.Concept(new jassa.sparql.ElementGroup([new jassa.sparql.ElementTriplesBlock([j]),new jassa.sparql.ElementFilter(new jassa.sparql.E_IsIri(new jassa.sparql.ExprVar(g)))]),g),l=jassa.sparql.ConceptUtils.createQueryList(k),m=new jassa.service.ListServiceSparqlQuery(a,l,k.getVar()),n=m.fetchItems().then(function(a){var b=a.map(function(a){var b=a.key.getUri();return b});return b});return n}]);var k=function(a){var c=b.rexPrefixMapping||new jassa.rdf.PrefixMappingImpl(jassa.vocab.InitialContext),d=jassa.rdf.NodeFactory.createUri(c.expandPrefix(b.rexSubject)),e=jassa.rdf.NodeFactory.createUri(c.expandPrefix(b.rexNavPredicate)),f=a.map(function(a){var f=jassa.rdf.NodeFactory.createUri(c.expandPrefix(a)),g=b.rexNavInverse?new jassa.rdf.Triple(f,e,d):new jassa.rdf.Triple(d,e,f);return g});h.triples=f};b.$watchCollection(i,function(a){a&&k(a)})}}}}}]),angular.module("ui.jassa.rex").directive("rexObject",["$parse",function(a){return{priority:13,restrict:"A",scope:!0,require:["^rexContext","^rexPredicate"],controller:angular.noop,compile:function(){return{pre:function(b,c,d,e){var f=e[1],g=(e[0],f.rexObjectScopes.length);d.rexObject||(d.rexObject=""+g),f.rexObjectScopes.push(b),syncAttr(a,b,d,"rexObject"),b.$on("$destroy",function(){jassa.util.ArrayUtils.removeItemStrict(f.rexObjectScopes,b)});var h=function(){var a={s:b.rexSubject,p:b.rexPredicate,i:b.rexObject};return a};b.$watch(function(){var a=h();return a},function(a){b.rexRef=a},!0),b.rexRef=h()}}}}}]),angular.module("ui.jassa.rex").directive("rexPredicate",["$parse",function(a){return{priority:17,restrict:"A",scope:!0,controller:["$scope",function(a){this.rexObjectScopes=a.rexObjectScopes=[]}],compile:function(){return{pre:function(b,c,d){syncAttr(a,b,d,"rexPredicate",!1,function(a){var c=b.rexPrefixMapping,d=c?c.expandPrefix(a):a;return d})}}}}}]),angular.module("ui.jassa.rex").directive("rexPrefix",["$parse",function(a){return{priority:19,restrict:"A",scope:!0,require:"rexContext",controller:["$scope",function(a){a.rexPrefix=a.rexPrefix||{}}],compile:function(b,c){return setEleAttrDefaultValue(b,c,"rex-prefix","rexPrefix"),{pre:function(b,c,d){var e=function(a){var c,d=b.$parent.rexPrefix,e=d?d.prefixes:jassa.vocab.InitialContext;c=e?Object.create(e):{};var f=jassa.util.PrefixUtils.parsePrefixDecls(a);return angular.extend(c,f),c};syncAttr(a,b,d,"rexPrefix",!0,e);var f=function(){b.rexPrefixMapping=new jassa.rdf.PrefixMappingImpl(b.rexPrefix),b.rexContext.prefixMapping=b.rexPrefixMapping};b.$watchGroup([function(){return b.rexPrefix},function(){return b.rexContext}],function(){f()},!0),f()}}}}}]),angular.module("ui.jassa.rex").directive("rexSparqlService",["$parse",function(a){return{priority:30,restrict:"A",scope:!0,controller:angular.noop,compile:function(){return{pre:function(b,c,d){syncAttr(a,b,d,"rexSparqlService")}}}}}]),angular.module("ui.jassa.rex").directive("rexSubject",["$parse","$q",function(a){return{priority:24,restrict:"A",scope:!0,require:"^rexContext",controller:angular.noop,compile:function(){return{pre:function(b,c,d,e){syncAttr(a,b,d,"rexSubject",!1,function(a){var c=b.rexPrefixMapping,d=c?c.expandPrefix(a):a;return d}),b.$on("destroy",function(){var a=e.$scope.rexContext;jassa.util.ObjectUtils.free(a.refSubjects,b.rexSubject)});var f=function(a,b){var c=e.$scope.rexContext;jassa.util.ObjectUtils.alloc(c.refSubjects,a),jassa.util.ObjectUtils.free(c.refSubjects,b)};f(b.rexSubject),b.$watch("rexSubject",f)}}}}}]),angular.module("ui.jassa.rex").directive("rexTerm",["$parse","$compile",function(a,b){return{priority:900,restrict:"A",scope:!0,terminal:!0,controller:angular.noop,compile:function(){return{pre:function(a,c,d){var e=d.rexTerm;if(jassa.util.ObjectUtils.isEmptyString(e)){var f=getModelAttribute(d);e=d[f]}if(!e)throw new Error("No model provided and found");c.removeAttr("rex-term"),c.attr("rex-termtype",e+".type"),c.attr("rex-datatype",e+".datatype"),c.attr("rex-lang",e+".lang"),c.attr("rex-value",e+".value"),b(c)(a)}}}}}]),angular.module("ui.jassa.rex").directive("rexTermtype",["$parse",function(a){return{priority:10,restrict:"A",scope:!0,require:["^rexContext","^rexObject","?ngModel"],controller:angular.noop,compile:function(){return createCompileComponent("rexTermtype","type",a)}}}]),angular.module("ui.jassa.rex").directive("rexTypeof",["$parse","$compile",function(a,b){return{priority:1e3,restrict:"A",scope:!0,terminal:!0,controller:angular.noop,compile:function(){return{pre:function(a,c){var d=c.attr("rex-typeof");c.removeAttr("rex-typeof"),c.attr("rex-predicate",'"http://www.w3.org/1999/02/22-rdf-syntax-ns#type"'),c.attr("rex-iri",d),b(c)(a)}}}}}]),angular.module("ui.jassa.rex").directive("rexValue",["$parse",function(a){return{priority:4,restrict:"A",scope:!0,require:["^rexContext","^rexObject","?ngModel"],controller:angular.noop,compile:function(){return createCompileComponent("rexValue","value",a)}}}]);var syncHelper=function(a,b,c,d,e,f,g,h,i){var j=b[e],k=i?d(j):c(j),l=b[f],m=c(l),n=m.assign,o=b[g],p=c(o),q=function(a){return a},r=b[h],s=c(r),t=function(){var b=s(a),c=angular.isUndefined(b)?!0:b;return c},u=function(){var b=t();if(b){var c=k(a),d=p(a)||q,e=d(c);n(a,e)}};a.$watch(function(){var a=t();return a},function(a){a&&u()}),a.$watch(function(){var b=p(a);return b},function(a){a&&u()}),a.$watch(function(){var b=k(a);return b},function(){u()},!0)};angular.module("ui.jassa.sync",[]),angular.module("ui.jassa.sync").directive("syncTemplate",["$parse","$compile",function(a,b){return{priority:1e3,restrict:"A",scope:!0,terminal:!0,controller:function(){},compile:function(){return{pre:function(a,c,d){var e=c.attr("sync-template");if(c.removeAttr("sync-template"),c.attr("sync-source",e),c.attr("sync-source-interpolate",""),null==c.attr("sync-target")){var f=getModelAttribute(d),g=d[f];if(!g)throw new Error("No model provided and found");c.attr("sync-target",g)}null==c.attr("sync-to-target")&&c.attr("sync-to-target",""),b(c)(a)}}}}}]),angular.module("ui.jassa.sync").directive("syncToSource",["$parse","$interpolate",function(a,b){return{priority:390,restrict:"A",controller:function(){},compile:function(){return{pre:function(c,d,e){syncHelper(c,e,a,b,"syncTarget","syncSource","syncToSource","syncToSourceCond",!1)}}}}}]),angular.module("ui.jassa.sync").directive("syncToTarget",["$parse","$interpolate",function(a,b){return{priority:390,restrict:"A",controller:function(){},compile:function(){return{pre:function(c,d,e){var f="syncSourceInterpolate"in e;syncHelper(c,e,a,b,"syncSource","syncTarget","syncToTarget","syncToTargetCond",f)}}}}}]),angular.module("template/geometry-input/geometry-input-typeahead.html",[]).run(["$templateCache",function(a){a.put("template/geometry-input/geometry-input-typeahead.html",'<div class="typeahead-group-header" ng-if="match.model.firstInGroup"><strong>Source:</strong> <em>{{match.model.group}}</em></div>\n<a>\n  <span ng-bind-html="match.label | typeaheadHighlight:query"></span>\n</a>')}]),angular.module("template/geometry-input/geometry-input.html",[]).run(["$templateCache",function(a){a.put("template/geometry-input/geometry-input.html",'<div class="geometry-input" style="height:375px;">\n  <div>\n    <input type="radio" value="point" name="geometry" ng-model="geometry" /><label>Point</label>\n    <input type="radio" value="line" name="geometry" ng-model="geometry" /><label>Line</label>\n    <input type="radio" value="polygon" name="geometry" ng-model="geometry" /><label>Polygon</label>\n    <input type="radio" value="box" name="geometry" ng-model="geometry" /><label>Box</label>\n  </div>\n  <!--input ng-model="searchString" class="form-control" type="text" placeholder="Search for a place"/-->\n\n  <div style="width: 100%; position: relative;">\n    <input ng-model="searchString"\n           placeholder="Search for a place (typeahead)"\n           typeahead-min-length="3"\n           typeahead-wait-ms="100"\n           typeahead-loading="isLoading"\n           typeahead-template-url="template/geometry-input/geometry-input-typeahead.html"\n           typeahead-min-length typeahead-on-select="onSelectGeocode($item)"\n           typeahead="item.label as item.label for item in fetchResults($viewValue)"\n           class="form-control" />\n    <div ng-if="isLoading" class="spinner">\n      <div class="double-bounce1"></div>\n      <div class="double-bounce2"></div>\n    </div>\n  </div>\n\n  <div class="map" style="width: 100%; height: 300px;"></div>\n</div>')}]),angular.module("template/rdf-term-input/rdf-term-input.html",[]).run(["$templateCache",function(a){a.put("template/rdf-term-input/rdf-term-input.html",'<div class="input-group">\n\n  <!-- Note: On some occasions its useful to remove the parent element of this directive for layouting with bootstrap\n       For this reason we can\'t use ng-form on the parent, and instead have to duplicate it for each input-group-addon :/\n   -->\n\n  <!-- Term type selector -->\n  <div ng-form="forms.type" class="input-group-addon" style="padding: 0px 0px !important;">\n    <ui-select name="value" ng-model="state.type" ng-model-options="ngModelOptions" ng-disabled="disabled" theme="selectize"  reset-search-input="false" style="width: 100px;line-height:0;" >\n      <ui-select-match placeholder="Termtype">{{$select.selected.displayLabel}}</ui-select-match>\n      <ui-select-choices style="z-index: 999;" repeat="item.id as item in termTypes | filter: $select.search">\n        <span ng-bind-html="item.displayLabel | highlight: $select.search"></span>\n      </ui-select-choices>\n    </ui-select>\n  </div>\n  <!-- Datatype selector -->\n  <div ng-form="forms.datatype" ng-show="state.type===vocab.typedLiteral" class="input-group-addon" style="border-left: 0px; padding: 0px 0px !important;">\n    <ui-select name="value" ng-model="state.datatype" ng-model-options="ngModelOptions" ng-disabled="disabled" theme="selectize" tagging="addDatatype" reset-search-input="false" style="width: 100px;line-height:0;" >\n      <ui-select-match placeholder="Datatype">{{$select.selected.displayLabel}}</ui-select-match>\n      <!--ui-select-choices repeat="item in datatypes | filter: $select.search" refresh="refreshDatatype($select.search)" refresh-delay="100"-->\n      <ui-select-choices style="z-index: 999;" repeat="item.id as item in datatypes | filter: $select.search">\n        <span ng-bind-html="item.displayLabel | highlight: $select.search"></span>\n      </ui-select-choices>\n    </ui-select>\n  </div>\n  <!-- Language selector -->\n  <div ng-form="forms.lang" ng-show="state.type===vocab.plainLiteral" class="input-group-addon" style="border-left: 0px; padding: 0px 0px !important;">\n    <ui-select name="value" ng-model="state.lang" ng-model-options="ngModelOptions" ng-disabled="disabled" theme="selectize" tagging="addLanguage" reset-search-input="false" style="width: 100px; line-height:0;" >\n      <ui-select-match placeholder="Language">{{$select.selected.displayLabel}}</ui-select-match>\n      <ui-select-choices style="z-index: 999;" repeat="item.id as item in langs | filter: $select.search">\n        <span ng-bind-html="item.displayLabel | highlight: $select.search"></span>\n      </ui-select-choices>\n    </ui-select>\n  </div>\n  <!-- Input -->\n  <div ng-form="forms.value" class="form-control margin-left-1" style="height: 35px !important; padding: 0px; border: 0px; margin: 0px">\n    <input name="value" type="text" style="width: 100%; height: 100%;" ng-model="state.value" ng-model-options="ngModelOptions">\n  </div>\n</div>')
}]);